<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <title>Game End System Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        #console {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .modal-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .modal-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }
        .modal-card h4 {
            margin-top: 0;
            color: #333;
        }
        .modal-card p {
            color: #666;
            margin: 10px 0;
        }
        .end-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .clean-board { background: #4CAF50; color: white; }
        .no-moves { background: #FF5722; color: white; }
        .time-up { background: #FF9800; color: white; }
        .high-score { background: #FFD700; color: black; }
        .stars-rating { background: #9C27B0; color: white; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéÆ Game End System Test</h1>
        <p>Testira modularni sistem za zavr≈°etak igre sa razliƒçitim modal-ima.</p>
        
        <div id="console"></div>
        
        <div class="test-section">
            <h3>1. System Initialization</h3>
            <p>Inicijalizuje game end sistem sa svim modal-ima.</p>
            <button onclick="initializeSystem()">Initialize System</button>
            <button onclick="testSystemStatus()">Check Status</button>
        </div>
        
        <div class="test-section">
            <h3>2. Modal Previews</h3>
            <p>Pregled svih dostupnih modal-a:</p>
            <div class="modal-preview">
                <div class="modal-card">
                    <h4>üéâ Clean Board Modal</h4>
                    <p>Prikazuje se kada je board potpuno oƒçi≈°ƒáen</p>
                    <span class="end-type clean-board">CLEAN_BOARD</span>
                    <br><br>
                    <button onclick="testModal('clean_board')">Test Modal</button>
                </div>
                
                <div class="modal-card">
                    <h4>üòî No Moves Modal</h4>
                    <p>Prikazuje se kada nema vi≈°e moguƒáih merge-ova</p>
                    <span class="end-type no-moves">NO_MOVES</span>
                    <br><br>
                    <button onclick="testModal('no_moves')">Test Modal</button>
                </div>
                
                <div class="modal-card">
                    <h4>‚è∞ Time Up Modal</h4>
                    <p>Prikazuje se kada vreme istekne</p>
                    <span class="end-type time-up">TIME_UP</span>
                    <br><br>
                    <button onclick="testModal('time_up')">Test Modal</button>
                </div>
                
                <div class="modal-card">
                    <h4>üèÜ High Score Modal</h4>
                    <p>Prikazuje se kada je postignut novi rekord</p>
                    <span class="end-type high-score">HIGH_SCORE</span>
                    <br><br>
                    <button onclick="testModal('high_score')">Test Modal</button>
                </div>
                
                <div class="modal-card">
                    <h4>‚≠ê Stars Rating Modal</h4>
                    <p>Prikazuje se za ocenu na osnovu score-a</p>
                    <span class="end-type stars-rating">STARS_RATING</span>
                    <br><br>
                    <button onclick="testModal('stars_rating')">Test Modal</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>3. Game Scenarios</h3>
            <p>Testira razliƒçite scenarije zavr≈°etka igre:</p>
            <button onclick="testCleanBoardScenario()">Clean Board Scenario</button>
            <button onclick="testNoMovesScenario()">No Moves Scenario</button>
            <button onclick="testTimeUpScenario()">Time Up Scenario</button>
            <button onclick="testHighScoreScenario()">High Score Scenario</button>
        </div>
        
        <div class="test-section">
            <h3>4. Integration Test</h3>
            <p>Testira integraciju sa glavnom igrom:</p>
            <button onclick="testIntegration()">Test Integration</button>
            <button onclick="testEndTypeDetection()">Test End Type Detection</button>
            <button onclick="clearConsole()">Clear Console</button>
        </div>
    </div>

    <script type="module">
        // Import modula
        let GameEndSystem, GameEndIntegration, GAME_END_TYPES;
        
        try {
            const systemModule = await import('./src/modules/game-end-system.js');
            const integrationModule = await import('./src/modules/game-end-integration.js');
            
            GameEndSystem = systemModule.gameEndManager;
            GameEndIntegration = integrationModule;
            GAME_END_TYPES = systemModule.GAME_END_TYPES;
            
            log('‚úÖ Game End modules loaded successfully', 'success');
        } catch (error) {
            log('‚ùå Failed to load modules: ' + error.message, 'error');
        }
        
        // Console logging
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            console.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }
        
        // Mock game context
        const mockGameContext = {
            tiles: [],
            makeBoard: {
                anyMergePossible: (tiles) => {
                    return tiles.some(tile => !tile.locked && tile.value > 0);
                }
            },
            hasWildOnBoard: () => false,
            score: 1250,
            level: 5,
            moves: 8,
            timeLeft: 0,
            movesLeft: 0,
            bestScore: 1000,
            mode: 'normal',
            app: { renderer: { width: 800, height: 600 } },
            stage: { addChild: () => {}, removeChild: () => {} },
            board: {},
            startLevel: (level) => log(`Starting level ${level}`, 'info'),
            restartGame: () => log('Restarting game', 'info'),
            quitGame: () => log('Quitting game', 'info')
        };
        
        // Test functions
        window.initializeSystem = function() {
            if (!GameEndIntegration) return;
            
            try {
                GameEndIntegration.initializeGameEndSystem();
                log('‚úÖ System initialized successfully', 'success');
            } catch (error) {
                log('‚ùå System initialization failed: ' + error.message, 'error');
            }
        };
        
        window.testSystemStatus = function() {
            if (!GameEndSystem) return;
            
            log('üìä System Status:', 'info');
            log(`- Modals registered: ${GameEndSystem.modals.size}`, 'info');
            log(`- Current modal: ${GameEndSystem.currentModal || 'None'}`, 'info');
            log(`- Processing: ${GameEndSystem.isProcessing}`, 'info');
        };
        
        window.testModal = async function(endType) {
            if (!GameEndSystem) return;
            
            try {
                log(`üé≠ Testing ${endType} modal...`, 'info');
                
                const result = await GameEndSystem.handleGameEnd({
                    ...mockGameContext,
                    // Simuliraj razliƒçite scenarije
                    tiles: endType === 'clean_board' ? 
                        Array(10).fill().map(() => ({ locked: true, value: 0 })) :
                        Array(10).fill().map(() => ({ locked: false, value: Math.floor(Math.random() * 5) + 1 })),
                    score: endType === 'high_score' ? 2000 : 1250,
                    bestScore: endType === 'high_score' ? 1000 : 2000,
                    timeLeft: endType === 'time_up' ? 0 : 30,
                    movesLeft: endType === 'moves_up' ? 0 : 10
                });
                
                log(`‚úÖ Modal ${endType} completed: ${result.action}`, 'success');
            } catch (error) {
                log(`‚ùå Modal ${endType} failed: ${error.message}`, 'error');
            }
        };
        
        window.testCleanBoardScenario = function() {
            testModal('clean_board');
        };
        
        window.testNoMovesScenario = function() {
            testModal('no_moves');
        };
        
        window.testTimeUpScenario = function() {
            testModal('time_up');
        };
        
        window.testHighScoreScenario = function() {
            testModal('high_score');
        };
        
        window.testIntegration = async function() {
            if (!GameEndIntegration) return;
            
            try {
                log('üîó Testing integration...', 'info');
                
                const result = await GameEndIntegration.integratedCheckLevelEnd(mockGameContext);
                log(`‚úÖ Integration test completed: ${result.action}`, 'success');
            } catch (error) {
                log(`‚ùå Integration test failed: ${error.message}`, 'error');
            }
        };
        
        window.testEndTypeDetection = function() {
            if (!GameEndSystem) return;
            
            const endType = GameEndSystem.testEndType(mockGameContext);
            log(`üéØ Detected end type: ${endType}`, 'info');
        };
        
        // Initialize on load
        window.onload = function() {
            log('üöÄ Game End System Test loaded', 'success');
            log('üìù Available end types: ' + Object.values(GAME_END_TYPES).join(', '), 'info');
        };
    </script>
</body>
</html>
